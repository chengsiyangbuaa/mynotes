# 恶意代码分析实战



## 第0章——恶意代码分析技术入门

### 0.1恶意代码分析目标

为一起网络入侵事件的**响应**提供所需信息。

- 如果系统安全被危及了，就有必要进行事件响应（incident response）。快速有效地对问题采取相应的行动是安全组的职责。
  事件响应是对问题和事件的有计划的反应。从信息安全的角度举例而言，它可以指安全小组在某个黑客已经攻破了防火墙，当前正在嗅探内部网络的交通时所采取的行动。该事件是对安全性的一种破坏。对它的响应就应该包括：安全小组在试图保证数据完好性的同时如何反应；他们采取哪些行动来减少损失；以及他们何时能够恢复资源。
- 想一想你自己所在的机构，想一想它在各方各面上有多大程度要依赖于科技和计算机系统。如果其中出现了漏洞或弱点，想像一下潜在的灾难性结果。除了最明显的系统停用和数据失窃以外，还可能会出现数据损害、身份失窃（从在线人事记录中）、消极媒介宣传、甚至由于顾客和商业伙伴在获悉攻击真相后采取消极态度所导致的灾难性财政结果。
- 对已往安全破坏（内部和外部）的研究表明，安全破坏有时会导致公司破产。安全破坏会使资源不可用，还会导致数据被损或被窃。但是我们不能忽略那些很难用金钱来衡量的问题，如消极宣传。要真正了解有效的事件响应的重要性，组织机构必须要计算安全破坏会给它带来的损失，以及它会如何短期和长期地受其影响。

**目标：确定到底发生什么，定位出所有受感染的主机和文件。确定某一个特定的可疑二进制程序可以做什么。如何在网络上测量它，如何衡量它的危害，消除它所带来的危害。**

编写检测特征码：在网络中检测出恶意代码感染的主机。

恶意代码分析可以用来编写基于主机和网络的检测**特征码**。

- 所谓特征码，就是防毒软件从病毒样本中提取的不超过64字节且能代表病毒特征的十六进制代码。主要有单一特征码、多重特征码和复合特征码这三种类型。特征码提取的思路是：首先获取一个病毒程序的长度，根据样本长度可将文件分为若干份(分段的方法在很大程度上避免了采用单一特征码误报病毒现象的发生，也可以避免特征码过于集中造成的误报)，每份选取16B或32B的特征串，若该信息是通用信息或者全零字节则舍弃，认为或随机调整偏移最后重新选取。最后，将选取出来的几段特征码及它们的偏移量存入病毒库，标示出病毒的名称即可。根据这个思路可编写出特征码提取程序实现自动提取，并保存病毒记录。在扫描病毒时，防毒软件将目标文件通过模式匹配算法与病毒库中的特征码进行比对，以确定是否染毒。

基于**主机**的特征码（感染迹象）：恶意代码创建或修改的文件，对注册表的特定修改。与反病毒软件使用的病毒特征码不同。恶意代码**感染迹象**关注的是恶意代码对系统做了什么，而不是恶意代码本身的特性。（恶意代码可能会动态变化，或者它会把自身删除）。

**网络**特征码：通过检测网络流量来检测恶意代码。

获取特征码后，就要弄清楚它们是**如何工作**的，这往往是高级管理员提出的问题，它们希望得到一起**重大入侵事件的详细解释**。

本书学到的技术，可以允许我**确定出恶意程序的目标和功能特性**。

### 0.2恶意代码分析技术

大部分情况，只有可执行文件本身（二进制，不可读）。使用各种**工具**和**技巧**才能看到一个全貌。

恶意代码分析方法：静态分析，动态分析。

细分为四类：静态分析基础技术，动态分析基础技术，静态分析高级技术，动态分析高级技术。

#### 静态分析基础技术

检查可执行文件但是不查看具体指令。

确认一个文件是否是恶意的，提供其有关其功能的信息，有的时候能够提供信息让我们能够生成简单的网络特征码，。

静态分析基础技术是很简单的，非常快速的，但是针对复杂的恶意代码是无效的。也会错过一些重要的行为。

#### 动态分析基础技术

运行恶意代码并且观察系统上的行为，以**移除感染**，产生有效的**检测特征码**。动态分析基础技术可以背大多数没有编程经验的人所使用。但是对复杂的恶意代码也是无效的，也会错过一些重要信息。

#### 静态分析高级技术

对恶意代码内部机制的**逆向工程**，通过将可执行文件装载到反汇编器中，查看程序指令，来发现恶意代码到底做什么。这些指令是被cpu执行的。所以静态分析高级技术能够告诉我们程序具体做了什么。但是学习路线比较陡峭，需要掌握**汇编语言**，**代码结构**，**windows操作系统**概念。

#### 动态分析基础技术

使用**调试器**检查一个恶意代码可执行程序运行时刻的内部状态。

### 0.3恶意代码类型

恶意代码分析时，猜测恶意代码样本在尝试做什么，验证猜想，可以加速分析过程。

知道恶意代码通常会做什么事，能够做出更准确的预测。

恶意代码分类如下

#### 后门（back door）

后门，本意是指一座建筑背面开设的门，通常比较隐蔽，为进出建筑的人提供方便和隐蔽。在信息安全领域，后门是指绕过安全控制而获取对程序或系统访问权的方法。后门的最主要目的就是方便以后再次秘密进入或者控制系统。

- 来源
  - 主机上的后门来源主要有以下几种：
    攻击者利用欺骗的手段，通过发送电子邮件或者文件，并诱使主机的操作员打开或运行藏有木马程序的邮件或文件，这些木马程序就会在主机上创建一个后门。
  - 攻击者攻陷一台主机，获得其控制权后，在主机上建立后门，比如安装木马程序，以便下一次入侵时使用。
  - 还有一种后门是软件开发过程中引入的。在软件的开发阶段，程序员常会在软件内创建后门以方便测试或者修改程序中的缺陷，但在软件发布时，后门被有意或者无意忽视了，没有被删除，那么这个软件天生就存在后门，安装该软件的主机就不可避免的引入了后门。
- 危害
  - 大多数入侵者的后门实现以下目的：
    即使管理员通过改变所有密码之类的方法来提高安全性，仍然能再次侵入，使再次侵入被发现的可能性减至最低。
  - 大多数后门设法躲过日志，大多数情况下即使入侵者正在使用系统也无法显示他已在线。
  - 后门的引入无疑会形成重大安全风险。知道后门的人，日后可以对系统进行隐蔽的访问和控制，而且后门也容易被入侵者当成漏洞进行攻击。

恶意代码分析实战2022_01_12

#### 僵尸网络

- 僵尸网络 Botnet 是指采用一种或多种传播手段，将大量主机感染bot程序（[僵尸程序](https://baike.baidu.com/item/僵尸程序)）病毒，从而在控制者和被感染[主机](https://baike.baidu.com/item/主机/455151)之间所形成的一个可一对多控制的网络 [1] 。

- 攻击者通过各种途径传播僵尸程序感染互联网上的大量主机，而被感染的主机将通过一个[控制信道](https://baike.baidu.com/item/控制信道/5623827)接收攻击者的指令，组成一个僵尸网络。之所以用僵尸网络这个名字，是为了更形象地让人们认识到这类危害的特点：众多的计算机在不知不觉中如同中国古老传说中的僵尸群一样被人驱赶和指挥着，成为被人利用的一种工具。

#### 下载器

- 用来下载其他恶意代码
- 通常是攻击者获得系统的访问时**首先**进行安装的。下载器会**下载和安装**其他的恶意代码

#### 间谍软件

- “间谍软件”其实是一个灰色区域，所以并没有一个明确的定义。然而，正如同名字所暗示的一样，它通常被泛泛的定义为从计算机上搜集信息，并在未得到该计算机用户许可时便将信息传递到第三方的软件，包括监视击键，搜集机密信息（密码、信用卡号、[PIN码](https://baike.baidu.com/item/PIN码)等），获取电子邮件地址，跟踪浏览习惯等。间谍软件还有一个副产品，在其影响下这些行为不可避免的影响网络性能，减慢系统速度，进而影响整个商业进程。虽然其原理也是基于[C/S模式](https://baike.baidu.com/item/C%2FS模式/5309599)的网络连接，但是在连接时却将态度转了180度：这次的入侵，发出第一个连接请求的不再是[远程控制](https://baike.baidu.com/item/远程控制)者使用的客户端，而是受害者的木马[服务器](https://baike.baidu.com/item/服务器)端。第一个使用此概念的木马名为“[网络神偷](https://baike.baidu.com/item/网络神偷)”，被设计用来从局域网内往外盗取文件数据。

#### 启动器

- 通常为可执行文件，用来安装立即运行或将来秘密执行的恶意代码，通常包含一段它所运行的恶意代码
- 用来**启动其他恶意程序**的恶意代码
- 通常情况下，启动器使用一些**非传统的技术**，来启动其他恶意程序，以确保**隐蔽性**，或以获得更高权限访问系统

#### 内核套件

- 设计用来**隐藏**其他恶意代码的恶意代码。内核套件通常是与其他恶意代码（如后门）组合工具套装，来允许为攻击者提供远程访问，并且使代码**很难被受害者发现**。

#### 勒索软件（ransomware）

- 一种流行的[木马](https://baike.baidu.com/item/木马/530)，通过骚扰、恐吓甚至采用绑架用户文件等方式，使用户数据资产或[计算资源](https://baike.baidu.com/item/计算资源/19140081)无法正常使用，并以此为条件向用户勒索钱财。这类用户数据资产包括文档、邮件、数据库、源代码、图片、压缩文件等多种文件。赎金形式包括真实货币、比特币或其它虚拟货币。

  一般来说，勒索软件作者还会设定一个支付时限，有时赎金数目也会随着时间的推移而上涨。有时，即使用户支付了赎金，最终也还是无法正常使用系统，无法还原被加密的文件。

#### 发送垃圾邮件的恶意代码

- 这类恶意代码在感染了计算机后，会利用其计算机和网络资源，发送大量垃圾邮件。通过出售垃圾邮件发送服务而收益。

#### 蠕虫或计算机病毒

- 可以自我复制和感染其他计算机的恶意代码。

恶意代码可能还会跨越类别。比如一个程序可能有一个键盘记录器，还有蠕虫组件。

#### 根据目标的分类

可以分为**大众型**和**针对型**两类。

### 0.4恶意代码的分析通用规则

- 不要过于陷于细节，不可能知道恶意代码的每一个细节，在进入到细节之前，要有一个概要认识。
- 针对不同的工作，使用不同的工具和方法。
- 恶意代码分析就像是猫捉老鼠的游戏，是双方的较量。